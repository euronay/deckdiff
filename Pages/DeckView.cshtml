@page "/deck"
@inject ILogger<Deck> logger;
@inject ScryfallApiClient scryfallApi


<h1>Deck builder</h1>

@foreach (var cardEntry in _deck.Main)
{
    <img src='@cardEntry.Card.ImageUris["normal"]' style="max-width: 320px;" />
}



<h2>Search</h2>
@if(_searchResults != null)
{
    <table>
        <thead>
            <td></td>
            <td>Name</td>
            <td></td>
        </thead>
        @foreach(var card in _searchResults)
        {
            <tr>
                <td><img src='@card.ImageUris["small"]' /></td>
                <td>@card.Name</td>
                <td>
                    <button class="btn btn-primary" onclick="@(() => Choose(card))">Select</button>
                </td>
            </tr>

        }
</table>
}


<p>
    <input type="text" bind="@_searchQuery" />
    <button class="btn btn-primary" onclick="@Search">Search</button>
</p>

@functions {

    private deckdiff.Model.Deck _deck { get; set; }
    private string _searchQuery {get; set; } 
    private IEnumerable<Card> _searchResults {get; set;}

    protected override async Task OnInitAsync()
    {
        _deck = new Deck();
    } 

    private async void Search()
    {
        //CurrentCard = null;
        _searchResults = null;

        var options = new SearchOptions
        {
            Sort = SearchOptions.CardSort.Cmc,
            Direction = SearchOptions.SortDirection.Desc,
            Mode = SearchOptions.RollupMode.Prints
        };

        var results = await scryfallApi.Cards.Search(_searchQuery, 1, options);
        logger.LogDebug($"Results count {results?.Data.Count()}");
        //CurrentCard = results?.Data.First();
        _searchResults = results?.Data;

        //https://github.com/aspnet/Blazor/issues/402
        StateHasChanged();
    }

    private void Choose(Card card)
    {
        _deck.Main.Add((1, card));
        StateHasChanged();
    }
}